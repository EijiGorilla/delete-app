import{aH as F,aQ as Lt,aI as zt,aR as Mt,aS as V,ar as Ot,P as Rt,jJ as $,jI as K,jC as xt,jH as wt,mb as Ut,mc as it,jS as rt,md as jt,me as ot,ci as Vt,bL as q,mf as Bt,cZ as Ft,aC as P,j$ as Tt,fP as Q,fU as Gt,kH as Ht,eb as kt,mg as Wt,mh as Nt,aN as lt,kW as Zt,mi as qt,mj as Jt,mk as Qt,ml as Kt,mm as Xt,aB as R,dG as ct,em as St,aD as Yt,en as X,mn as te,mo as ee,mp as ne,mq as se,kk as ae,mr as ie,dB as k,dC as re,dA as ut}from"./index-BfJ9e5wW.js";import{t as oe,e as ht}from"./SnappingCandidate-DGkpYqI6.js";import{a as le}from"./renderingInfoUtils-D0GoVNpN.js";import{h as Pt,i as ce}from"./triangulationUtils-CyD03mZ-.js";function ue(e,t,n,a){const s=Pt(e.rings,!!e.hasZ&&a.mode!=="on-the-ground",1,e.spatialReference),i=F(s.position.length),r=Lt(s.position,e.spatialReference,0,i,0,s.position,0,s.position.length/3,t,n,a),o=r!=null;return new de(s.position,i,Ct(s.polygons,s.position,i),vt(s.outlines,s.position,i),o,r)}function Le(e,t){const n=Pt(e.rings,!1,1),a=zt(n.position,e.spatialReference,0,n.position,t,0);for(let s=2;s<n.position.length;s+=3)n.position[s]=Mt;return{position:n.position,polygons:Ct(n.polygons,n.position),outlines:vt(n.outlines,n.position),projectionSuccess:a}}function vt(e,t,n=null){return e.filter(({count:a})=>a>1).map(({index:a,count:s})=>{const i=3*a,r=3*s;return n!=null?new Et(a,s,V(t,i,r),V(n,i,r)):new Y(a,s,V(t,i,r))})}function Ct(e,t,n=null){const a=new Array;for(const{index:s,count:i,holeIndices:r,pathLengths:o}of e){if(i<=1)continue;const l=3*s,b=3*i,x=r.map(g=>g-s),f=n!=null?new he(s,i,V(t,3*s,3*i),V(n,l,b),x,o):new pe(s,i,V(t,3*s,3*i),x,o);a.push(f)}return a}let Y=class{constructor(t,n,a){this.index=t,this.count=n,this.position=a}};class Et extends Y{constructor(t,n,a,s){super(t,n,a),this.mapPositions=s}}class he extends Et{constructor(t,n,a,s,i,r){super(t,n,a,s),this.holeIndices=i,this.pathLengths=r}}class pe extends Y{constructor(t,n,a,s,i){super(t,n,a),this.holeIndices=s,this.pathLengths=i}}class de{constructor(t,n,a,s,i,r){this.position=t,this.mapPositions=n,this.polygons=a,this.outlines=s,this.projectionSuccess=i,this.sampledElevation=r}}function Me(e,t,n){const a=(t.length>0?t[0]:e.length/3)-1,s=ce(e,a,n);if(s!==2){e=e.slice();for(let i=0;i<e.length;i+=3)e[i+s]=e[i+2]}return xt(e,t,3)}function Oe(e){const t=[["position",new $(e.attributeData.position,e.indices,3,!0)]],n=wt(e.indices.length);return e.attributeData.colorFeature!=null?t.push(["colorFeatureAttribute",new $([e.attributeData.colorFeature],n,1,!0)]):e.attributeData.color&&t.push(["color",new $(e.attributeData.color,n,4,!0)]),e.attributeData.uvMapSpace&&t.push(["uvMapSpace",new $(e.attributeData.uvMapSpace,e.indices,4,!0)]),e.attributeData.boundingRect&&t.push(["boundingRect",new $(e.attributeData.boundingRect,e.indices,9,!0)]),new K(e.material,t,e.mapPositions,0,e.attributeData.olidColor)}function Re(e,t=null){const n=[["position",new $(e.attributeData.position,e.indices,3,!0)],["uv0",new $(e.attributeData.uv0,e.indices,2,!0)]];return new K(e.material,n,e.mapPositions,0,t)}function me(e){switch(e.type){case"extent":if(e instanceof Ot)return Rt.fromExtent(e);break;case"polygon":return e}return null}class Ue{constructor(t,n,a){this.renderData=t,this.layerViewUid=n,this.graphicUid=a,this.outGeometries=new Array}}const ge=["polygon","extent"];class je extends Ut{constructor(t,n,a,s){super(t,n,a,s,xe(n)),this.ensureDrapedStatus(!1)}async doLoad(){const t=this.symbolLayer,n=t?.material,a=this.symbolLayer.material?.color?.a,s=this.needsDrivenTransparentPass||a!=null&&a!==1,i=n?.emissive,r=!this._hasDrivenColorOrOpacity&&(a==null||a===0),o={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,ambient:rt,diffuse:rt,opacity:r?0:1,layerOpacity:this._getLayerOpacity(),drivenOpacity:s,hasSymbolColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:t.castShadows,emissiveStrength:i?.strength??0,emissiveSource:1,offsetTransparentBackfaces:!0,normalType:1},l=new it(o,this._context),b=new it({...o,cullFace:2},this._context);this._materials[0]=l,this._materials[1]=b,this._updateTransparentDepedentMaterialParameters()}destroy(){super.destroy(),this._materials.length=0}createGraphics3DGraphic(t){const n=t.graphic;if(!this._validateGeometry(n.geometry,ge,this.symbolLayer.type))return null;const a=this._getDrivenUInt8ColorWithNaNSupport(t.renderingInfo,this._materialColor,!1);jt(a,a);const s=this.createElevationContextForGraphic(n);return this._createAs3DShape(n,t.renderingInfo,a,s,n.uid)}layerOpacityChanged(t,n){const a=this._getLayerOpacity();this._materials[0]?.setParameters({layerOpacity:a}),this._materials[1]?.setParameters({layerOpacity:a}),this._updateTransparentDepedentMaterialParameters(),t?.forEach(s=>n(s)?.layerOpacityChanged(a,this._context.isAsync))}layerScreenSizePerspectiveChanged(){}layerElevationInfoChanged(t,n){return this.updateGraphics3DGraphicElevationInfo(t,n,ot)}slicePlaneEnabledChanged(t,n){return this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._materials[1]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),t?.forEach(a=>{const s=n(a);s?.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){const t={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0};return this._materials[0]?.setParameters(t),this._materials[1]?.setParameters(t),!0}_getExtrusionSize(t){let n;return n=t.size&&this._drivenProperties.size?le(t.size,2)??0:this._getSymbolSize(),n/=this._context.renderCoordsHelper.unitInMeters,n}applyRendererDiff(t,n){return this._drivenPropertiesChanged(n)?0:1}async queryForSnapping(t,n,a,s){const i=this._getExtrusionSize(a)*this._context.renderCoordsHelper.unitInMeters/Vt(n),{objectId:r,target:o}=t,l=q(o);switch(l.z=(l.z??0)+i,t.type){case"edge":{const{start:b,end:x}=t,f=q(b),g=q(x);return f.z=(f.z??0)+i,g.z=(g.z??0)+i,[ht(r,l,1/0,f,g)]}case"vertex":return[oe(r,l,1/0),ht(r,o,1/0,o,l)];default:return[]}}_getSymbolSize(){return this.symbolLayer.size??1}_createAs3DShape(t,n,a,s,i){const r=me(t.geometry);if(r==null)return null;if(r.rings.length===0||!r.rings.some(C=>C.length>0))return this._logGeometryValidationWarnings(r.rings,"rings","ExtrudeSymbol3DLayer"),null;const o=ue(r,this._context.elevationProvider,this._context.renderCoordsHelper,s);this._logGeometryCreationWarnings(o,r.rings,"rings","ExtrudeSymbol3DLayer");const l=Bt(r);if(l==null)return null;const b=new Array,x=new Array,f=Ft(),g=Q(),w=P(),p=this._context.renderCoordsHelper.viewingMode===1;p||this._context.renderCoordsHelper.worldUpAtPosition(null,w),Tt(r.spatialReference,[l.x,l.y,0],g,this._context.renderCoordsHelper.spatialReference);const _=Q();Gt(_,g);const m=kt();Ht(m,_);const{polygons:y,mapPositions:c,position:d}=o,h=new Map,v=this._materials[0];for(const C of y){const z=C.count;if(this._context.clippingExtent&&(Wt(C.mapPositions,f),!Nt(f,this._context.clippingExtent)))continue;const M=xt(C.mapPositions,C.holeIndices,3);if(M.length===0)continue;const O=M.length,D=6*z,U=lt(D+O),W=lt(O),T=F(3*D),tt=F(3*D),et=F(3*D),nt=F(D);ye(d,c,M,C,T,et,tt,nt,U,W,this._getExtrusionSize(n),w,p),Zt(T,T,_);const st=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:i,layerViewUid:this._context.layerViewUid}),N=new Ce(T,et,qt(tt),nt),Z=pt(v,U,U.length-W.length,N,a,st),$t=z,At=z,It=2*C.count,at=new Ee($t,At,It,O/3);Dt(Z,at,g),h.set(Z,at),b.push(Z,pt(this._materials[1],W,0,N,a,st)),x.push(N.heights)}if(b.length===0)return null;const u=new Jt({geometries:b,layerViewUid:this._context.layerViewUid,graphicUid:i,isElevationSource:!0});u.transformation=g;const A=Qt(this.symbolLayer,{opacity:this._getLayerOpacity()}),I=A?new Kt(this._materials[0],A,this._context.slicePlaneEnabled):null,L=new Xt(this,u,null,(C,z,M,O,D)=>be(C,z,M,O,D,x,h),s,I);return L.alignedSampledElevation=o.sampledElevation,L.needsElevationUpdates=ot(s.mode),L}get _materialColor(){return this.symbolLayer.material?.color}_updateTransparentDepedentMaterialParameters(){const t=this._materials[0];t&&t.setParameters({cullFace:t.transparent?0:2})}}function pt(e,t,n,a,s,i){const r=wt(t.length),o=[["position",new $(a.positions,t,3,!0)],["normalCompressed",new $(a.normals,t,2,!0)],["symbolColor",new $(s,r,4,!0)]];return new K(e,o,a.elevation,0,i,n)}function ye(e,t,n,a,s,i,r,o,l,b,x,f,g){const w=n.length/3;let p=2*a.count;fe(e,t,a.index,a.count,n,0,w,s,i,r,o,l,b,p,x,f,g);let _=0,m=2*a.count;p=0;const y=a.pathLengths[0];dt(s,i,o,r,_,y,a.count,m,l,p,x),m+=4*y,p+=2*y,_+=y;for(let c=1;c<a.pathLengths.length;++c){const d=a.pathLengths[c];dt(s,i,o,r,_,d,a.count,m,l,p,x),m+=4*d,p+=2*d,_+=d}}function fe(e,t,n,a,s,i,r,o,l,b,x,f,g,w,p,_,m){re(E,_),l??=[],b??=[],x??=[];const y=p>0?1:-1;let c=3*n,d=0,h=3*d,v=a,u=3*v;for(let L=0;L<a;++L){const C=e[c],z=e[c+1],M=e[c+2];m&&(E[0]=C,E[1]=z,E[2]=M,X(E,E)),o[h+0]=C,o[h+1]=z,o[h+2]=M;const O=t[c+0],D=t[c+1],U=t[c+2];l[h+0]=O,l[h+1]=D,l[h+2]=U,b[h+0]=-y*E[0],b[h+1]=-y*E[1],b[h+2]=-y*E[2],x[d]=0,o[u+0]=C+p*E[0],o[u+1]=z+p*E[1],o[u+2]=M+p*E[2],l[u+0]=O,l[u+1]=D,l[u+2]=U,x[v]=p,h+=3,u+=3,c+=3,d+=1,v+=1}c=3*i,h=0,u=3*w;const A=p<0?bt:_t,I=p<0?_t:bt;for(let L=0;L<r;++L)g[h]=s[c+A[0]],g[h+1]=s[c+A[1]],g[h+2]=s[c+A[2]],f[u]=s[c+I[0]]+a,f[u+1]=s[c+I[1]]+a,f[u+2]=s[c+I[2]]+a,h+=3,u+=3,c+=3}function G(e,t,n,a,s,i,r){a[i]=a[r],r*=3,e[i*=3]=e[r],e[i+1]=e[r+1],e[i+2]=e[r+2],t[i]=t[r],t[i+1]=t[r+1],t[i+2]=t[r+2],n[i]=s[0],n[i+1]=s[1],n[i+2]=s[2]}const B=P();function dt(e,t,n,a,s,i,r,o,l,b,x){t??=[],n??=[],a??=[];let f=s,g=s+1,w=s+r,p=s+r+1,_=o,m=o+1,y=o+2*i,c=o+2*i+1;x<0&&(f=s+r+1,p=s);let d=3*b;for(let h=0;h<i;++h)h===i-1&&(g=s,x>0?p=s+r:f=s+r),_e(e,f,g,w,B),G(e,t,a,n,B,_,f),G(e,t,a,n,B,m,g),G(e,t,a,n,B,y,w),G(e,t,a,n,B,c,p),l[d]=_,l[d+1]=y,l[d+2]=c,l[d+3]=_,l[d+4]=c,l[d+5]=m,d+=6,f++,g++,w++,p++,_+=2,m+=2,y+=2,c+=2}const J=P(),mt=P(),gt=P(),yt=P(),ft=P();function _e(e,t,n,a,s){t*=3,n*=3,a*=3,R(J,e[t++],e[t++],e[t++]),R(mt,e[n++],e[n++],e[n++]),R(gt,e[a++],e[a++],e[a++]),ut(yt,mt,J),ut(ft,gt,J),St(s,ft,yt),X(s,s)}const j=P();function be(e,t,n,a,s,i,r){const o=e.stageObject,l=o.geometries,b=l.length,x=t.mode!=="absolute-height";let f=0;const g=o.transformation,w=ee(Q(),g);for(let p=0;p<b;p+=2){const _=l[p];if(!ne(_))continue;const m=_.getMutableAttribute("position").data,y=i[p/2],c=new se(_.mapPositions),d=m.length/3;let h=!1,v=0;{let u=0;for(let A=0;A<d;A++){j[0]=m[u],j[1]=m[u+1],j[2]=m[u+2],a(c,H),x&&(v+=H.sampledElevation),ie.TESTS_DISABLE_OPTIMIZATIONS?(R(S,c.array[c.offset],c.array[c.offset+1],H.z+y[u/3]),n!=null&&s.toRenderCoords(S,n,S),k(S,S,w)):(R(S,m[u],m[u+1],m[u+2]),k(S,S,g),s.setAltitude(S,H.z+y[u/3]),k(S,S,w)),m[u]=S[0],m[u+1]=S[1],m[u+2]=S[2];const I=we/s.unitInMeters;(Math.abs(j[0]-m[u])>=I||Math.abs(j[1]-m[u+1])>=I||Math.abs(j[2]-m[u+2])>=I)&&(h=!0),c.offset+=3,u+=3}}if(h){const u=r.get(_);u&&Dt(_,u,g),o.geometryVertexAttributeUpdated(l[p],"normalCompressed"),_.invalidateBoundingInfo(),o.geometryVertexAttributeUpdated(l[p],"position"),l[p+1].invalidateBoundingInfo(),o.geometryVertexAttributeUpdated(l[p+1],"position")}f+=v/d}return f/b}function Dt(e,t,n){const a=e.getMutableAttribute("position"),s=e.getMutableAttribute("normalCompressed").data,i=a.data,r=e.attributes.get("position").indices,{topVertexStart:o,topVertexCount:l,topFaceStart:b,topFaceCount:x}=t,f=b+x,g=o+l,w=Se,p=Pe,_=ve,m=E,y=S;R(y,0,0,0);const c=(d,h)=>{const v=3*d;R(h,i[v+0],i[v+1],i[v+2]),k(h,h,n)};for(let d=b;d<f;++d){const h=3*d;c(r[h+0],w[0]),c(r[h+1],w[1]),c(r[h+2],w[2]),ct(p,w[1],w[0]),ct(_,w[2],w[0]),St(m,p,_),Yt(y,y,m)}X(y,y);for(let d=o;d<g;++d){const h=y[0],v=y[1],u=y[2];te(s,d,h,v,u)}}function xe(e){return(e.material?.color?.a??0)===1}const S=P(),E=P(),H=new ae,_t=[0,2,1],bt=[0,1,2],we=.01,Se=[P(),P(),P()],Pe=P(),ve=P();class Ce{constructor(t,n,a,s){this.positions=t,this.elevation=n,this.normals=a,this.heights=s}}class Ee{constructor(t,n,a,s){this.topVertexStart=t,this.topVertexCount=n,this.topFaceStart=a,this.topFaceCount=s}}export{je as K,ye as X,Ue as a,Re as c,me as l,Le as p,ue as r,Oe as s,Me as u};
