import{d7 as E,fP as B,j$ as D,aU as H,aC as b,b4 as Q,B as w,bK as J,k0 as Z,Q as N,J as V,eg as A,k1 as X,bG as Y,fU as _,k2 as ee,k3 as L,k4 as te,aT as K,dw as P,aB as ne,dg as U,dB as M,k5 as C,c$ as re,g$ as ae,dC as oe,k6 as se}from"./index-DqWSGd-C.js";import{n as ie}from"./featurePopupQueryUtils-ur2_rSnG.js";import{S as le,v as ce}from"./I3SBinaryReader-B5624_97.js";function ue(e,t,n,r,a){const o=n==="east-north-up"?E(e):fe(e,t,r),u=B();return D(r,o,u,a),u}const z=1,F=5-z;function fe(e,t,n){const r=b(),a=e[3],o=2**(Math.ceil(Math.log(a)*Math.LOG2E/F)*F+z);if(n.isGeographic){const i=o/H(n).radius*180/Math.PI,f=Math.round(e[1]/i),h=Math.max(-90,Math.min(90,f*i)),c=i/Math.cos((Math.abs(h)-i/2)/180*Math.PI),m=Math.round(e[0]/c)*c;r[0]=m,r[1]=h}else{const i=Math.round(e[0]/o),f=Math.round(e[1]/o);r[0]=i*o,r[1]=f*o}const u=e[2]+t,l=Math.round(u/o);return r[2]=l*o,r}function j(e){return e?parseInt(e.slice(e.lastIndexOf("/")+1),10):void 0}function Ke(e){if(N("disable-feature:i3s-draco")||!e)return!1;for(const t of e)for(const n of t.geometryBuffers)if(n.compressedAttributes?.encoding==="draco")return!0;return!1}function Ae(e,t,n,r){n.traverse(t,a=>{const o=a.serviceMbsInIndexSR;return(o!=null&&de(e,o))!==0&&(r(a),!0)})}function Le(e,t,n){let r=0,a=0;for(let o=0;o<t.length&&r<e.length;o++)e[r]===t[o]&&(n(o)&&(e[a]=e[r],a++),r++);e.length=a}function Pe(e,t,n){let r=0,a=0;for(;r<n.length;)Z(e,n[r])>=0===t&&(n[a]=n[r],a++),r++;n.length=a}function Ue(e,t){if(t.rotationScale[1]===0&&t.rotationScale[2]===0&&t.rotationScale[3]===0&&t.rotationScale[5]===0&&t.rotationScale[6]===0&&t.rotationScale[7]===0)return v[0]=(e[0]-t.position[0])/t.rotationScale[0],v[1]=(e[1]-t.position[1])/t.rotationScale[4],v[2]=(e[2]-t.position[0])/t.rotationScale[0],v[3]=(e[3]-t.position[1])/t.rotationScale[4],v}const v=K();function de(e,t){const n=t[0],r=t[1],a=t[3],o=e[0]-n,u=n-e[2],l=e[1]-r,i=r-e[3],f=Math.max(o,u,0),h=Math.max(l,i,0),c=f*f+h*h;return c>a*a?0:c>0?1:-Math.max(o,u,l,i)>a?3:2}function he(e,t,n){const r=[],a=n?.missingFields,o=n?.originalFields;let u=!1;for(const l of e){const i=t.get(l);i?(o?.push(l),r.push(i.name),l!==i.name&&(u=!0)):a?.push(l)}return n&&"hasMismatchedCasing"in n&&(n.hasMismatchedCasing=u),r}async function Fe(e,t,n,r,a,o){if(t.length===0)return[];const u=e.attributeStorageInfo;if(e.associatedLayer!=null)try{return await ye(e.associatedLayer,t,r,o)}catch(l){if(e.associatedLayer.loaded)throw l}if(u){const l=pe(e,t,n,a),i=e.parsedUrl.path;return await Promise.allSettled(l.map(f=>ge(i,u,f.node,f.indices,r,e.apiKey,e.customParameters,o).then(h=>{for(let c=0;c<f.graphics.length;c++){const m=f.graphics[c],y=h[c];if(m.attributes)for(const s in m.attributes)s in y||(y[s]=m.attributes[s]);m.attributes=y}}))),t}throw new w("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available")}function pe({globalIdField:e},t,n,r){const a=new Map,o=[],u=r();for(const l of t){const i=l.attributes?.[n],f=i==null?l.getGlobalId():void 0;for(let h=0;h<u.length;h++){const c=u[h],m=me(c,i,e,f);if(m<0)continue;let y=a.get(c.node);y||(y={node:c.node,indices:[],graphics:[]},o.push(y),a.set(c.node,y)),y.indices.push(m),y.graphics.push(l);for(let s=h;s>0;s--)u[s]=u[s-1];u[0]=c;break}}return o}function me(e,t,n,r){if(t!=null&&typeof t=="number")return e.featureIds.indexOf(t);if(r==null||n==null)return-1;const a=e.attributeInfo?.attributeData?.[n];return a?a.indexOf(r):-1}async function ye(e,t,n,r){const a=[],o={hasMismatchedCasing:!1,originalFields:a},u=he(n,e.fieldsIndex,o),l=new Y({outFields:[...u]});if(await ie(e,t,l,{updateSourceAttributes:!0,...r}),!o.hasMismatchedCasing)return t;for(let i=0;i<t.length;i++){const f=t[i];if(f.attributes)for(let h=0;h<a.length;h++){const c=a[h],m=u[h];m in f.attributes&&(f.attributes[c]=f.attributes[m],delete f.attributes[m])}}return t}function ge(e,t,n,r,a,o,u,l){return be(e,t,n.resources.attributes,r,a,o,u,l)}async function be(e,t,n,r,a,o,u,l){const i=[];for(const c of t)if(c&&a.includes(c.name)){const m=`${e}/nodes/${n}/attributes/${c.key}/0`;i.push({url:m,storageInfo:c})}const f=await Promise.allSettled(i.map(c=>Q(c.url,{responseType:"array-buffer",query:{...u,token:o},signal:l?.signal}).then(m=>le(c.storageInfo,m.data)))),h=[];for(const c of r){const m={};for(let y=0;y<f.length;y++){const s=f[y];if(s.status==="fulfilled"){const p=s.value;m[i[y].storageInfo.name]=ce(p,c)}}h.push(m)}return h}function we(e){const t=e.store,n=t.indexCRS||t.geographicCRS,r=n===void 0?t.indexWKT:void 0;if(r){if(!e.spatialReference)throw new w("layerview:no-store-spatial-reference-wkt-index-and-no-layer-spatial-reference","Found indexWKT in the scene layer store but no layer spatial reference",{});if(r!==e.spatialReference.wkt)throw new w("layerview:store-spatial-reference-wkt-index-incompatible","The indexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const a=n?new J(j(n)):e.spatialReference;return a.equals(e.spatialReference)?e.spatialReference:a}function Me(e){const t=e.store,n=t.vertexCRS||t.projectedCRS,r=n===void 0?t.vertexWKT:void 0;if(r){if(!e.spatialReference)throw new w("layerview:no-store-spatial-reference-wkt-vertex-and-no-layer-spatial-reference","Found vertexWKT in the scene layer store but no layer spatial reference",{});if(r!==e.spatialReference.wkt)throw new w("layerview:store-spatial-reference-wkt-vertex-incompatible","The vertexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const a=n?new J(j(n)):e.spatialReference;return a.equals(e.spatialReference)?e.spatialReference:a}function G(e,t,n){if(!V(e,t))throw A("scene layer",e?.wkid,t?.wkid);if(n==="local"&&!ve(e,t))throw A("scene layer",e?.wkid,t?.wkid)}function qe(e,t,n){if(e.serviceUpdateTimeStamp?.lastUpdate!==t.serviceUpdateTimeStamp?.lastUpdate||!n.isEmpty||e.associatedLayer?.url!==t.associatedLayer?.url)throw new w("layerview:recycle-failed","Could not recycle layerview")}function ve(e,t){return e.equals(t)||e.isWGS84&&t.isWebMercator||e.isWebMercator&&t.isWGS84}function Se(e,t,n){const r=we(e),a=Me(e);G(r,t,n),G(a,t,n)}function xe(e){return(e.geometryType==null||e.geometryType==="triangles")&&(e.topology==null||e.topology==="PerAttributeArray")&&e.vertexAttributes?.position!=null}function Oe(e){if(e.store?.defaultGeometrySchema==null||!xe(e.store.defaultGeometrySchema))throw new w("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{url:e.parsedUrl.path})}function Ee(e,t){Se(e,t.spatialReference,t.viewingMode)}function $e(e){return e.geometryType!=null&&e.geometryType==="points"&&(e.topology==null||e.topology==="PerAttributeArray")&&(e.encoding==null||e.encoding===""||e.encoding==="lepcc-xyz")&&e.vertexAttributes?.position!=null}function Be(e){if(e.store?.defaultGeometrySchema==null||!$e(e.store.defaultGeometrySchema))throw new w("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{})}function Je(e,t){G(e.spatialReference,t.spatialReference,t.viewingMode)}function Ie(e){return e.type==="simple"||e.type==="class-breaks"||e.type==="unique-value"}function Re(e){return e.type==="mesh-3d"}function ze(e){if(e==null||!Ie(e)||(e.type==="unique-value"||e.type==="class-breaks")&&e.defaultSymbol==null)return!0;const t=e.symbols;if(t.length===0)return!0;for(const n of t){if(!Re(n)||n.symbolLayers.length===0)return!0;for(const r of n.symbolLayers.items)if(r.type!=="fill"||r.material?.color==null||r.material.colorMixMode!=="replace")return!0}return!1}const je=X({color:[0,0,0,0],opacity:0});class ke{constructor(){this.edgeMaterial=null,this.material=null,this.castShadows=!0}}function De(e){const t=new ke;let n=!1,r=!1;for(const a of e.symbolLayers.items)if(a.type==="fill"&&a.enabled){const o=a.material,u=a.edges;if(o!=null&&!n){const l=o.color,i=ee(o.colorMixMode),f={strength:o.emissive?.strength??L,source:o.emissive?.source==="color"?1:0};t.material=l!=null?{color:[l.r/255,l.g/255,l.b/255],alpha:l.a,colorMixMode:i,emissive:f}:{color:[1,1,1],alpha:1,colorMixMode:1,emissive:f},t.castShadows=a.castShadows,n=!0}u==null||r||(t.edgeMaterial=te(u,{}),r=!0)}return t.material||(t.material={color:[1,1,1],alpha:1,colorMixMode:1,emissive:{strength:L,source:0}}),t}function He(e,t){return(0|e)+(0|t)|0}function Qe(e,t,n,r,a,o,u){if(!o||o.length===0||t==null||!e.serviceMbsInIndexSR)return null;const l=ue(e.serviceMbsInIndexSR,a,"none",n,t);_(I,l);let i=null;const f=()=>{if(!i)if(i=Te,P($),e.serviceObbInIndexSR!=null){e.serviceObbInIndexSR.transform(q,n,t,a,u),q.getCorners(i);for(const s of i)M(s,s,I),C($,s)}else{const s=e.serviceMbsInIndexSR;if(!s)return;const p=s[3];U(E(s),n,d,t),M(d,d,I),d[2]+=a;for(let g=0;g<8;++g){const S=1&g?p:-p,R=2&g?p:-p,k=4&g?p:-p,x=i[g];oe(x,[d[0]+S,d[1]+R,d[2]+k]),C($,x)}}};let h=1/0,c=-1/0;const m=s=>{if(s.type!=="replace")return;const p=s.geometry;if(!p?.hasZ)return;P(W);const g=p.spatialReference||r,S=p.rings.reduce((R,k)=>k.reduce((x,T)=>(ne(d,T[0],T[1],T[2]),U(d,g,d,t),M(d,d,I),C(W,d),Math.min(d[2],x)),R),1/0);f(),re($,W)&&(h=Math.min(h,S),c=Math.max(c,S))};if(o.forEach(s=>m(s)),h===1/0)return null;const y=(s,p,g)=>{M(d,g,l),s[p]=d[0],s[p+1]=d[1],s[p+2]=d[2],p+=24,g[2]=h,M(d,g,l),s[p]=d[0],s[p+1]=d[1],s[p+2]=d[2],p+=24,g[2]=c,M(d,g,l),s[p]=d[0],s[p+1]=d[1],s[p+2]=d[2]};for(let s=0;s<8;++s)y(O.data,3*s,i[s]);return se(O)}function Ze(e){return e[3]>=0}function Ne(e){e!=null&&(e[3]=-1)}const Te=[b(),b(),b(),b(),b(),b(),b(),b()],W=K(),$=K(),q=new ae,d=b(),O={data:new Array(72),size:3,exclusive:!0,stride:3},I=B();export{be as $,Le as A,Ae as C,G as D,de as F,he as G,Se as J,Pe as K,Ue as L,Fe as P,Me as Q,Ke as W,Oe as X,Ee as Y,qe as Z,De as a,Qe as c,Be as e,Ne as f,ue as i,He as l,ze as n,je as s,Je as t,Ze as u,we as z};
